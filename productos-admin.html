<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Productos | Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body class="app-space">

<div class="d-flex">
  <aside class="sidebar sidebar-app">
    <div class="p-3 border-app border-bottom">
      <div class="d-flex align-items-center gap-2">
        <span class="brand-dot"></span>
        <div class="fw-bold text-white">FERJER</div>
      </div>
      <small class="text-app-muted">Administración</small>
    </div>

    <nav class="p-2" id="sidebarNav"></nav>

    <div class="p-3 mt-auto border-app border-top">
      <button id="btnLogout" class="btn btn-app-outline w-100">Cerrar sesión</button>
    </div>
  </aside>

  <main class="flex-grow-1">

    <header class="topbar-app">
      <div class="container-fluid py-3">
        <h1 class="h5 mb-0 fw-semibold text-white">Productos</h1>
        <small class="text-app-muted">Alta y listado</small>
      </div>
    </header>

    <section class="container-fluid py-4">
      <div class="row g-3">

        <!-- FORM (col 4) -->
        <div class="col-lg-4">
          <div class="card card-app rounded-4">
            <div class="card-body">

              <div class="d-flex align-items-center justify-content-between">
                <h2 class="h6 fw-semibold mb-0 text-white">Productos</h2>

                <button class="btn btn-app btn-sm"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapseProdForm"
                        aria-expanded="false"
                        aria-controls="collapseProdForm">
                  + Agregar
                </button>
              </div>

              <div class="collapse mt-3" id="collapseProdForm">
                <form id="prodForm">

                  <div class="mb-2">
                    <label class="form-label text-app-muted">Nombre</label>
                    <input class="form-control input-app" id="pNombre" required>
                  </div>

                  <div class="mb-2">
                    <label class="form-label text-app-muted">Precio</label>
                    <input class="form-control input-app" id="pPrecio" type="number" step="0.01" min="0" required>
                  </div>

                  <div class="mb-2">
                    <label class="form-label text-app-muted">Stock</label>
                    <input class="form-control input-app" id="pStock" type="number" min="0" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label text-app-muted">Imagen</label>
                    <input class="form-control input-app" id="pImg" type="file" accept=".jpg,.jpeg,.png,.webp">
                    <div class="form-text text-app-muted">Formatos: jpg, png, webp</div>
                  </div>

                  <div id="prodMsg" class="alert d-none"></div>

                  <button class="btn btn-success w-100" type="submit">Guardar</button>
                </form>
              </div>

              <div class="mt-3 text-app-muted small">
                Tip: Mantén stock actualizado para evitar ventas sin inventario.
              </div>

            </div>
          </div>
        </div>

        <!-- LIST (col 8) -->
        <div class="col-lg-8">
          <div class="card card-app rounded-4">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between">
                <h2 class="h6 fw-semibold mb-0 text-white">Listado</h2>
                <button class="btn btn-app-outline btn-sm" id="btnProdReload">Actualizar</button>
              </div>

              <div class="table-responsive mt-3 table-shell">
                <table class="table table-app table-hover align-middle mb-0">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Imagen</th>
                      <th>Nombre</th>
                      <th>Precio</th>
                      <th>Stock</th>
                    </tr>
                  </thead>
                  <tbody id="prodBody"></tbody>
                </table>
              </div>

              <div id="prodEmpty" class="text-center text-app-muted py-4 d-none">
                No hay productos aún.
              </div>

            </div>
          </div>
        </div>

      </div>
    </section>

  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/app.js"></script>

<script>
  async function loadProductos() {
    const body = document.getElementById("prodBody");
    const empty = document.getElementById("prodEmpty");
    try {
      const data = await apiFetch("api/productos/list.php");
      const rows = data.data || [];

      body.innerHTML = rows.map(p => `
        <tr>
          <td class="fw-semibold">${p.id_producto}</td>
          <td style="width:90px;">
            ${p.imagen_url
              ? `<img src="${p.imagen_url}" class="prod-thumb">`
              : `<span class="text-app-muted small">-</span>`
            }
          </td>
          <td class="fw-semibold">${p.nombre}</td>
          <td class="fw-semibold">$${Number(p.precio).toFixed(2)}</td>
          <td><span class="badge badge-stock">${p.stock}</span></td>
        </tr>
      `).join("");

      if (rows.length === 0) empty.classList.remove("d-none");
      else empty.classList.add("d-none");

    } catch (e) {
      body.innerHTML = `<tr><td colspan="5" class="text-danger">Error: ${e.message}</td></tr>`;
    }
  }

  document.getElementById("btnProdReload")?.addEventListener("click", loadProductos);

  document.getElementById("prodForm")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const msg = document.getElementById("prodMsg");
    msg.classList.add("d-none");

    const fd = new FormData();
    fd.append("nombre", document.getElementById("pNombre").value.trim());
    fd.append("precio", document.getElementById("pPrecio").value);
    fd.append("stock", document.getElementById("pStock").value);

    const file = document.getElementById("pImg").files[0];
    if (file) fd.append("imagen", file);

    try {
      const res = await fetch("api/productos/create.php", {
        method: "POST",
        credentials: "same-origin",
        body: fd
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error("Respuesta no JSON: " + text); }
      if (!res.ok || data.ok === false) throw new Error(data.error || "Error al guardar");

      msg.className = "alert alert-success";
      msg.textContent = "Producto guardado ✅";
      msg.classList.remove("d-none");
      e.target.reset();
      loadProductos();

    } catch (err) {
      msg.className = "alert alert-danger";
      msg.textContent = err.message;
      msg.classList.remove("d-none");
    }
  });

  document.addEventListener("DOMContentLoaded", loadProductos);
</script>

</body>
</html>