<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mis pedidos | FERJER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-body-tertiary">

  <div class="d-flex">
    <aside class="sidebar bg-white border-end">
      <div class="p-3 border-bottom">
        <div class="fw-bold">FERJER</div>
        <small class="text-secondary">Sistema de seguimiento</small>
      </div>
      <nav class="p-2" id="sidebarNav"></nav>
      <div class="p-3 mt-auto border-top">
        <button id="btnLogout" class="btn btn-outline-secondary w-100">Cerrar sesi√≥n</button>
      </div>
    </aside>

    <main class="flex-grow-1">
      <header class="bg-white border-bottom">
        <div class="container-fluid py-3 d-flex align-items-center justify-content-between">
          <div>
            <h1 class="h5 mb-0 fw-semibold">Mis pedidos</h1>
            <small class="text-secondary">Historial de compras</small>
          </div>
          <span class="text-secondary small" id="topbarUsuario"></span>
        </div>
      </header>

      <section class="container-fluid py-4">

        <div class="alert alert-warning d-flex align-items-center gap-2 mb-4">
          <span style="font-size:1.2rem;">üè™</span>
          <div>Los pedidos <strong>no se env√≠an a domicilio</strong>. Pasa a recoger tu pedido directamente en tienda.</div>
        </div>

        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-body">
            <div id="pedidosEmpty" class="text-center text-secondary py-4 d-none">
              A√∫n no tienes pedidos realizados.
            </div>
            <div id="pedidosLista"></div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {

      function estatusBadge(estatus) {
        if (estatus === "Pagado")    return "text-bg-primary";
        if (estatus === "Entregado") return "text-bg-success";
        return "text-bg-secondary";
      }

      function estatusTexto(estatus) {
        if (estatus === "Pagado")    return "‚è≥ Pendiente de recoger";
        if (estatus === "Entregado") return "‚úÖ Entregado";
        return estatus;
      }

      function abrirTicket(pedido, items) {
        const lineas = items.map(i => `
          <tr>
            <td>${i.nombre}</td>
            <td style="text-align:center">${i.cantidad}</td>
            <td style="text-align:right">$${Number(i.precio_unit).toFixed(2)}</td>
            <td style="text-align:right">$${Number(i.subtotal).toFixed(2)}</td>
          </tr>
        `).join("");

        const ventana = window.open("", "_blank");
        ventana.document.write(`
          <!doctype html>
          <html lang="es">
          <head>
            <meta charset="utf-8">
            <title>Ticket #${pedido.id_pedido}</title>
            <style>
              body { font-family: Arial, sans-serif; max-width: 400px; margin: 30px auto; color: #333; }
              h1 { font-size: 22px; margin-bottom: 0; }
              .sub { color: #777; font-size: 13px; margin-bottom: 16px; }
              .divider { border-top: 1px dashed #ccc; margin: 12px 0; }
              table { width: 100%; border-collapse: collapse; font-size: 13px; }
              th { text-align: left; border-bottom: 1px solid #ccc; padding: 4px 0; }
              td { padding: 4px 0; }
              .total { font-size: 16px; font-weight: bold; text-align: right; margin-top: 10px; }
              .footer { font-size: 12px; color: #888; text-align: center; margin-top: 20px; }
              @media print { button { display: none; } }
            </style>
          </head>
          <body>
            <h1>FERJER</h1>
            <div class="sub">Sistema de seguimiento de equipos</div>
            <div class="divider"></div>
            <div style="font-size:13px;">
              <strong>Pedido #${pedido.id_pedido}</strong><br>
              Fecha: ${pedido.fecha_pedido ?? "-"}<br>
              Cliente: ${pedido.cliente}<br>
              Correo: ${pedido.email}
            </div>
            <div class="divider"></div>
            <table>
              <thead>
                <tr>
                  <th>Producto</th>
                  <th style="text-align:center">Cant.</th>
                  <th style="text-align:right">Precio</th>
                  <th style="text-align:right">Subtotal</th>
                </tr>
              </thead>
              <tbody>${lineas}</tbody>
            </table>
            <div class="divider"></div>
            <div class="total">Total: $${Number(pedido.total).toFixed(2)} MXN</div>
            <div class="divider"></div>
            <div class="footer">
              üè™ Tu pedido solo se entrega en tienda.<br>
              Pres√©ntate con este ticket para recogerlo.<br><br>
              ¬°Gracias por tu compra!
            </div>
            <br>
            <button onclick="window.print()" style="width:100%;padding:10px;background:#0d6efd;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
              üñ®Ô∏è Imprimir / Guardar PDF
            </button>
          </body>
          </html>
        `);
        ventana.document.close();
      }

      try {
        const data    = await apiFetch(BASE_API + "pedidos/mis_pedidos.php");
        const pedidos = data.data || [];

        if (!pedidos.length) {
          document.getElementById("pedidosEmpty").classList.remove("d-none");
          return;
        }

        document.getElementById("pedidosLista").innerHTML = pedidos.map(p => `
          <div class="border rounded-4 p-3 mb-3">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <span class="fw-semibold">Pedido #${p.id_pedido}
                <span class="text-secondary fw-normal small ms-1">${p.fecha_pedido ?? ""}</span>
              </span>
              <span class="badge ${estatusBadge(p.estatus)}">${estatusTexto(p.estatus)}</span>
            </div>
            <div class="text-secondary small mb-2">${p.productos ?? "-"}</div>
            ${p.notas ? `<div class="text-secondary small mb-2"><em>${p.notas}</em></div>` : ""}
            <div class="d-flex justify-content-between align-items-center mt-2">
              <span class="fw-bold">$${Number(p.total).toFixed(2)} MXN</span>
              <button class="btn btn-sm btn-outline-secondary btn-ver-ticket" data-id="${p.id_pedido}">
                üñ®Ô∏è Ver ticket
              </button>
            </div>
          </div>
        `).join("");

        // Evento para ver ticket
        document.getElementById("pedidosLista").addEventListener("click", async (e) => {
          const btn = e.target.closest(".btn-ver-ticket");
          if (!btn) return;

          const id = btn.getAttribute("data-id");
          btn.disabled = true;
          btn.textContent = "Cargando...";

          try {
            const det = await apiFetch(BASE_API + "pedidos/detalle_pedido.php?id=" + id);
            abrirTicket(det.pedido, det.items);
          } catch (err) {
            alert("No se pudo cargar el ticket: " + err.message);
          } finally {
            btn.disabled = false;
            btn.textContent = "üñ®Ô∏è Ver ticket";
          }
        });

      } catch (err) {
        document.getElementById("pedidosLista").innerHTML =
          `<div class="text-danger">Error: ${err.message}</div>`;
      }
    });
  </script>
</body>
</html>