<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entregas Pendientes | FERJER</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body class="bg-body-tertiary">

  <div class="d-flex">

    <!-- Sidebar -->
    <aside class="sidebar bg-white border-end">
      <div class="p-3 border-bottom">
        <div class="fw-bold">FERJER</div>
        <small class="text-secondary">Sistema de seguimiento</small>
      </div>
      <nav class="p-2" id="sidebarNav"></nav>
      <div class="p-3 mt-auto border-top">
        <button id="btnLogout" class="btn btn-outline-secondary w-100">Cerrar sesión</button>
      </div>
    </aside>

    <!-- Content -->
    <main class="flex-grow-1">

      <!-- Topbar -->
      <header class="bg-white border-bottom">
        <div class="container-fluid py-3 d-flex align-items-center justify-content-between">
          <div>
            <h1 class="h5 mb-0 fw-semibold">Entregas pendientes</h1>
            <small class="text-secondary">Pedidos listos para recoger en tienda</small>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="text-secondary small">Usuario: <span class="fw-semibold" id="topUsuario">-</span></span>
          </div>
        </div>
      </header>

      <section class="container-fluid py-4">

        <!-- Contador -->
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-4">
              <div class="card-body">
                <div class="text-secondary small">Pedidos por entregar</div>
                <div class="fs-3 fw-bold text-warning" id="kpiPendientes">0</div>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card shadow-sm border-0 rounded-4">
              <div class="card-body">
                <div class="text-secondary small">Entregados hoy</div>
                <div class="fs-3 fw-bold text-success" id="kpiEntregadosHoy">0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de entregas -->
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-3">
              <div>
                <h2 class="h6 fw-semibold mb-0">Pedidos en espera</h2>
                <small class="text-secondary">Marca como entregado cuando el cliente recoja su pedido</small>
              </div>
              <button class="btn btn-sm btn-outline-secondary" id="btnRefresh">
                ↻ Actualizar
              </button>
            </div>

            <div class="alert alert-info d-none" id="emptyEntregas">
              No hay pedidos pendientes de entrega en este momento. ✅
            </div>

            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0" id="tablaEntregas">
                <thead class="table-light">
                  <tr>
                    <th>#Pedido</th>
                    <th>Cliente</th>
                    <th>Productos</th>
                    <th>Total</th>
                    <th>Fecha pedido</th>
                    <th>Estatus</th>
                    <th class="text-end">Acción</th>
                  </tr>
                </thead>
                <tbody id="entregasBody">
                  <tr>
                    <td colspan="7" class="text-center text-secondary py-4">Cargando...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- Modal confirmar entrega -->
  <div class="modal fade" id="modalEntrega" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content rounded-4">
        <div class="modal-header">
          <h5 class="modal-title">Confirmar entrega</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>¿Confirmas que el cliente <strong id="meCliente">-</strong> ya recogió su pedido <strong id="mePedido">-</strong>?</p>
          <p class="text-secondary small">Productos: <span id="meProductos">-</span></p>
          <div class="alert alert-warning">
            Esta acción no se puede deshacer.
          </div>
          <div class="alert d-none" id="meMsg"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarEntrega">✓ Confirmar entrega</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // Mostrar nombre usuario
      const session = getSession();
      const topUsuario = document.getElementById("topUsuario");
      if (topUsuario && session) topUsuario.textContent = session.name || "-";

      const entregasBody   = document.getElementById("entregasBody");
      const emptyEntregas  = document.getElementById("emptyEntregas");
      const kpiPendientes  = document.getElementById("kpiPendientes");
      const kpiEntregadosHoy = document.getElementById("kpiEntregadosHoy");

      let entregasPendientes = [];
      let pedidoSeleccionado = null;

      // Modal
      const modalEl = document.getElementById("modalEntrega");
      const modal   = bootstrap.Modal.getOrCreateInstance(modalEl);

      function badgeEstatus(estatus) {
        if (estatus === "Pagado") return "text-bg-primary";
        if (estatus === "Listo")  return "text-bg-success";
        return "text-bg-secondary";
      }

      async function cargarEntregas() {
        entregasBody.innerHTML = `<tr><td colspan="7" class="text-center text-secondary py-4">Cargando...</td></tr>`;
        try {
          const data = await apiFetch("api/pedidos/entregas.php");
          entregasPendientes = data.data || [];

          kpiPendientes.textContent = entregasPendientes.length;

          if (entregasPendientes.length === 0) {
            entregasBody.innerHTML = "";
            emptyEntregas?.classList.remove("d-none");
            return;
          }

          emptyEntregas?.classList.add("d-none");

          entregasBody.innerHTML = entregasPendientes.map(e => `
            <tr>
              <td class="fw-semibold">#${e.id_pedido}</td>
              <td>
                <div>${e.cliente}</div>
                <div class="text-secondary small">${e.email}</div>
              </td>
              <td class="text-secondary small">${e.productos}</td>
              <td class="fw-semibold">$${Number(e.total).toFixed(2)}</td>
              <td class="text-secondary small">${e.fecha_pedido}</td>
              <td><span class="badge ${badgeEstatus(e.estatus)}">${e.estatus}</span></td>
              <td class="text-end">
                <button class="btn btn-sm btn-success btn-entregar"
                        data-id="${e.id_pedido}"
                        data-cliente="${e.cliente}"
                        data-productos="${e.productos}">
                  ✓ Entregar
                </button>
              </td>
            </tr>
          `).join("");

        } catch (err) {
          entregasBody.innerHTML = `<tr><td colspan="7" class="text-danger">Error: ${err.message}</td></tr>`;
        }
      }

      // Abrir modal al dar click en Entregar
      entregasBody.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-entregar");
        if (!btn) return;

        pedidoSeleccionado = parseInt(btn.getAttribute("data-id"));
        document.getElementById("meCliente").textContent  = btn.getAttribute("data-cliente");
        document.getElementById("mePedido").textContent   = "#" + pedidoSeleccionado;
        document.getElementById("meProductos").textContent = btn.getAttribute("data-productos");
        document.getElementById("meMsg")?.classList.add("d-none");

        modal.show();
      });

      // Confirmar entrega
      document.getElementById("btnConfirmarEntrega").addEventListener("click", async () => {
        if (!pedidoSeleccionado) return;

        const btn  = document.getElementById("btnConfirmarEntrega");
        const meMsg = document.getElementById("meMsg");

        btn.disabled    = true;
        btn.textContent = "Guardando...";

        try {
          await apiFetch("api/pedidos/entregas.php", {
            method: "POST",
            body: JSON.stringify({ id_pedido: pedidoSeleccionado })
          });

          modal.hide();
          // Actualizar contador de entregados hoy
          const actual = parseInt(kpiEntregadosHoy.textContent || "0");
          kpiEntregadosHoy.textContent = actual + 1;

          await cargarEntregas();

        } catch (err) {
          meMsg.className  = "alert alert-danger";
          meMsg.textContent = err.message || "No se pudo confirmar la entrega";
          meMsg.classList.remove("d-none");
        } finally {
          btn.disabled    = false;
          btn.textContent = "✓ Confirmar entrega";
        }
      });

      // Botón refrescar
      document.getElementById("btnRefresh")?.addEventListener("click", cargarEntregas);

      // Auto-actualizar cada 30 segundos
      cargarEntregas();
      setInterval(cargarEntregas, 30000);
    });
  </script>
</body>
</html>